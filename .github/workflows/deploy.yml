name: Deploy MkDocs to GitHub Pages

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install system deps (Cairo for social cards)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libcairo2 \
            libpango-1.0-0 \
            libpangocairo-1.0-0 \
            libgdk-pixbuf2.0-0 \
            libffi-dev

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build
        run: mkdocs build --strict

      - name: Deploy
        run: mkdocs gh-deploy --force

      - name: Notify success
        if: success()
        run: |
          curl -s \
            -H "Title: Docs site deployed" \
            -H "Priority: min" \
            -H "Tags: rocket" \
            -d "Site deployed successfully to developer.piratemidi.com
          Commit: ${{ github.event.head_commit.message }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            "ntfy.sh/${{ secrets.NTFY_TOPIC }}"

      - name: Notify failure
        if: failure()
        run: |
          curl -s \
            -H "Title: Docs site deploy failed" \
            -H "Priority: high" \
            -H "Tags: x" \
            -d "Site deployment to GitHub Pages failed.
          Commit: ${{ github.event.head_commit.message }}
          Check the run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            "ntfy.sh/${{ secrets.NTFY_TOPIC }}"
